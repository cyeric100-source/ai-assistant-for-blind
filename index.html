<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è¦–éšœåŠ©ç† (2025 å…¨èƒ½åŠ å¯†ç„¡éšœç¤™ç‰ˆ)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/lib/marked.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>

    <!-- PDF.js v5.4.449 æ ¸å¿ƒ -->
    <script type="module">
        if (window.location.protocol === 'file:') {
            document.documentElement.innerHTML = `
                <body style="background:#000; color:#fff; display:flex; flex-direction:column; justify-content:center; align-items:center; height:100vh; margin:0; font-family:sans-serif;">
                    <h1 style="color:yellow; font-size:2.5rem; text-align:center;">âš ï¸ ç’°å¢ƒéŒ¯èª¤</h1>
                    <p style="font-size:1.5rem; text-align:center; max-width:800px; line-height:1.6;">æœ¬ç¨‹å¼ä¸æ”¯æ´åœ¨æœ¬æ©Ÿç›´æ¥é–‹å•Ÿï¼Œè«‹ä¸Šå‚³è‡³ GitHub Pages ä½¿ç”¨ã€‚</p>
                </body>
            `;
            throw new Error("Local execution blocked.");
        }

        const PDF_BASE = './pdf-dist/pdf.mjs';
        const WORKER_URL = './pdf-dist/pdf.worker.mjs';

        async function initPdfSystem() {
            try {
                const pdfjsLib = await import(PDF_BASE);
                window.pdfjsLib = pdfjsLib;
                pdfjsLib.GlobalWorkerOptions.workerSrc = WORKER_URL;
                console.log("PDF System Ready");
                window.dispatchEvent(new Event('pdfjs-loaded'));
            } catch (e) {
                console.error("PDF Init Failed:", e);
                window.reportError("PDF æ ¸å¿ƒè¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèª pdf-dist è³‡æ–™å¤¾å­˜åœ¨ã€‚");
            }
        }
        initPdfSystem();
    </script>
    
    <style>
        :root {
            --bg-color: #000000; --text-color: #FFFFFF; --accent-color: #FFFF00;
            --user-header-color: #0088ff; --ai-header-color: #FFFF00;
            --border-color: #555; --input-bg: #1A1A1A;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color); color: var(--text-color);
            margin: 0; padding: 60px 0 0 0; font-size: 1.2rem; line-height: 1.6;
            user-select: none;
        }
        
        .container { max-width: 900px; margin: 0 auto; padding: 10px 10px 450px 10px; }

        input, select, textarea {
            width: 100%; padding: 12px; margin: 5px 0 10px 0;
            background: var(--input-bg); border: 2px solid var(--border-color);
            color: var(--text-color); font-size: 1.1rem; border-radius: 6px; box-sizing: border-box;
        }

        *:focus-visible { outline: 5px solid var(--accent-color) !important; outline-offset: 2px; }

        button {
            background-color: var(--accent-color); color: #000;
            border: 2px solid #fff; padding: 15px; font-size: 1.2rem; font-weight: bold;
            border-radius: 8px; cursor: pointer;
        }
        button:disabled { filter: grayscale(100%); opacity: 0.5; }
        button.secondary { background-color: #333; color: #fff; border-color: #777; }
        button.danger { background-color: #660000; color: #fff; border-color: #ff4444; }

        #status-bar-container { position: fixed; top: 0; left: 0; right: 0; z-index: 2000; }
        #status-bar { 
            background: #222; color: #fff; padding: 12px; text-align: center; 
            font-weight: bold; border-bottom: 3px solid var(--accent-color);
        }

        .message {
            background: #111; padding: 20px; margin-bottom: 30px;
            border-left: 8px solid var(--border-color); outline: none;
        }
        .message.user { border-left-color: var(--user-header-color); }
        .message.assistant { border-left-color: var(--ai-header-color); }
        .msg-heading { font-size: 1.5rem; margin-top: 0; outline: none; }

        .controls-wrapper {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #000; border-top: 4px solid var(--accent-color); padding: 15px;
        }
        .row { display: flex; gap: 10px; margin-bottom: 10px; }
        .hidden { display: none !important; }
        
        .markdown-body { overflow-wrap: break-word; }
        .markdown-body p { margin-bottom: 15px; }
        
        /* åŠ å¼·å°æ¯”åº¦èˆ‡ç„¡éšœç¤™ */
        summary h2 { display: inline; font-size: 1.3rem; }
        details { border: 1px solid #444; padding: 10px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div id="status-bar-container">
    <div id="status-bar" role="status" aria-live="polite">ç³»çµ±å°±ç·’</div>
</div>

<div class="container">
    <h1 class="app-title" style="text-align:center;">AI è¦–éšœåŠ©ç† (2025 åŠ å¯†ç„¡éšœç¤™ç‰ˆ)</h1>

    <details id="settings-area">
        <summary role="button"><h2>ç³»çµ±è¨­å®š (Alt+Shift+S)</h2></summary>
        <div style="margin-top: 15px;">
            <label for="provider-select">æœå‹™å•†:</label>
            <select id="provider-select" onchange="handleProviderChange()">
                <option value="gemini">Google Gemini (æ¨è–¦ 3.0/2.5)</option>
                <option value="openrouter">OpenRouter</option>
                <option value="openai">OpenAI</option>
            </select>

            <label for="api-key">API Key (åŠ å¯†å„²å­˜):</label>
            <input type="password" id="api-key" placeholder="åœ¨æ­¤è¼¸å…¥é‡‘é‘°">
            
            <label for="model-select">æ¨¡å‹:</label>
            <div class="row">
                <select id="model-select" onchange="handleModelSelectChange()"></select>
                <button type="button" class="secondary" onclick="fetchOnlineModels()">æ›´æ–°æ¸…å–®</button>
            </div>

            <div id="custom-model-wrapper" class="hidden">
                <input type="text" id="custom-model-input" placeholder="æ‰‹å‹•è¼¸å…¥æ¨¡å‹ ID">
            </div>

            <label class="row" style="align-items:center; background:#222; padding:10px;">
                <input type="checkbox" id="enter-to-send" checked style="width:25px; height:25px; margin-right:10px;">
                <span>æŒ‰ Enter å‚³é€</span>
            </label>

            <button type="button" onclick="saveSettings()" style="width:100%;">å„²å­˜è¨­å®š (åŠ å¯†ä¸¦å„²å­˜)</button>
        </div>
    </details>

    <details open style="background:#112233;">
        <summary><h2>PDF æ™ºèƒ½é–±è®€å™¨</h2></summary>
        <div style="padding:10px;">
            <button type="button" id="pdf-start-btn" onclick="document.getElementById('pdf-tool-input').click()" style="width:100%;" disabled>
                ğŸ“„ è®€å– PDF æ–‡ä»¶
            </button>
            <input type="file" id="pdf-tool-input" class="hidden" accept="application/pdf" onchange="handlePDFToolFileSelect()">
            
            <div class="row" style="margin-top:10px;">
                <label style="flex:1; display:flex; align-items:center;">
                    <input type="checkbox" id="pdf-translate" style="width:20px; height:20px;"> ç¿»è­¯æˆç¹é«”ä¸­æ–‡
                </label>
            </div>
        </div>
    </details>

    <main id="chat-output" class="message-area"></main>
</div>

<footer class="controls-wrapper">
    <div class="row">
        <button type="button" onclick="resetConversation()" class="danger" style="flex:1;">æ¸…é™¤å°è©±</button>
        <button type="button" id="voice-btn" class="secondary" style="flex:2; height:80px;">æŒ‰ä½èªªè©±</button>
    </div>
    <div class="row">
        <textarea id="user-input" placeholder="è¼¸å…¥å•é¡Œ..." rows="3" style="flex:4;"></textarea>
        <button type="button" id="submit-btn" onclick="handleSubmit()" style="flex:1; height:80px;">å‚³é€</button>
    </div>
</footer>

<script>
    /** 
     * å®‰å…¨åŠ å¯†æ¨¡çµ„ (AES-GCM)
     * ç”¨æ–¼å°‡ API Key åŠ å¯†å¾Œå„²å­˜è‡³ localStorageï¼Œç¢ºä¿ä¸æœƒè¢«æƒ¡æ„ç¨‹å¼è®€å–ç´”æ–‡å­—ã€‚
     */
    const CryptoHelper = {
        async _getKey() {
            const base = "2025-AI-ASSISTANT-SALT"; // å…§éƒ¨é¹½å€¼
            const enc = new TextEncoder();
            const keyMaterial = await crypto.subtle.importKey("raw", enc.encode(base), 'PBKDF2', false, ['deriveKey']);
            return crypto.subtle.deriveKey(
                { name: 'PBKDF2', salt: enc.encode('unique-salt'), iterations: 100000, hash: 'SHA-256' },
                keyMaterial, { name: 'AES-GCM', length: 256 }, false, ['encrypt', 'decrypt']
            );
        },
        async encrypt(text) {
            if(!text) return "";
            const key = await this._getKey();
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const encoded = new TextEncoder().encode(text);
            const ciphertext = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, encoded);
            const combined = new Uint8Array(iv.length + ciphertext.byteLength);
            combined.set(iv); combined.set(new Uint8Array(ciphertext), iv.length);
            return btoa(String.fromCharCode(...combined));
        },
        async decrypt(cipherBase64) {
            if(!cipherBase64) return "";
            try {
                const combined = new Uint8Array(atob(cipherBase64).split('').map(c => c.charCodeAt(0)));
                const iv = combined.slice(0, 12);
                const data = combined.slice(12);
                const key = await this._getKey();
                const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, data);
                return new TextDecoder().decode(decrypted);
            } catch(e) { return ""; }
        }
    };

    /** æ¨¡å‹èˆ‡æœå‹™å•†è¨­å®š */
    const PROVIDERS = {
        gemini: {
            models: ["gemini-3-flash-preview", "gemini-2.5-flash", "gemini-1.5-pro", "gemini-1.5-flash"],
            default: "gemini-3-flash-preview",
            url: "https://generativelanguage.googleapis.com/v1beta/models/{MODEL}:generateContent?key={KEY}"
        },
        openrouter: {
            models: ["google/gemini-2.5-flash", "openai/gpt-4o", "anthropic/claude-3.5-sonnet"],
            default: "google/gemini-2.5-flash",
            url: "https://openrouter.ai/api/v1/chat/completions"
        }
    };

    let chatHistory = [];
    let currentActiveModelId = "";
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    /** æ ¸å¿ƒï¼šç‹€æ…‹ç®¡ç†èˆ‡ç„¡éšœç¤™æœ—è®€æ§åˆ¶ */
    function updateStatusBar(text, status = 'ready', announce = true) {
        const bar = document.getElementById('status-bar');
        bar.innerText = text;
        // å¦‚æœ announce ç‚º trueï¼Œå‰‡è¨­ç‚º polite è®“è¢å¹•é–±è®€å™¨æœ—è®€ï¼›å¦å‰‡é—œé–‰æœ—è®€ï¼ˆé¿å…é€²åº¦å™ªéŸ³ï¼‰
        bar.setAttribute('aria-live', announce ? 'polite' : 'off');
        if(status === 'busy') bar.style.background = '#664400';
        else if(status === 'error') bar.style.background = '#660000';
        else bar.style.background = '#222';
    }

    /** æ ¸å¿ƒï¼šè¨Šæ¯èˆ‡ç„¦é»ç®¡ç† */
    function addMessage(role, content) {
        const output = document.getElementById('chat-output');
        const div = document.createElement('div');
        div.className = `message ${role}`;
        div.tabIndex = -1; // å®¹å™¨å¯ç²å–ç„¦é»
        
        const heading = document.createElement('h1');
        heading.className = 'msg-heading';
        heading.tabIndex = -1; // æ¨™é¡Œè¨­ç‚ºå¯ç²å–ç„¦é»
        heading.innerText = role === 'user' ? 'æˆ‘çš„å•é¡Œï¼š' : 'åŠ©ç†å›æ‡‰ï¼š';
        
        const body = document.createElement('div');
        body.className = 'markdown-body';
        body.innerHTML = DOMPurify.sanitize(marked.parse(content));
        
        div.appendChild(heading);
        div.appendChild(body);
        output.appendChild(div);
        
        // ä¿®æ­£ï¼šAI çµ¦äºˆå›æ‡‰å¾Œï¼Œè‡ªå‹•å°‡ç„¦é»ç§»è‡³æ–°æ¨™é¡Œï¼Œç¢ºä¿è¢å¹•é–±è®€å™¨ç«‹å³è®€å–
        setTimeout(() => heading.focus(), 100);
        return div;
    }

    /** æ ¸å¿ƒï¼šé‡‘é‘°è‡ªå‹•è§£å¯†èˆ‡è¼‰å…¥ */
    async function initSettings() {
        const p = localStorage.getItem('provider') || 'gemini';
        document.getElementById('provider-select').value = p;
        
        const encryptedKey = localStorage.getItem(`${p}_key_enc`);
        if(encryptedKey) {
            document.getElementById('api-key').value = await CryptoHelper.decrypt(encryptedKey);
        }
        
        handleProviderChange(false);
    }

    function handleProviderChange(reset = true) {
        const p = document.getElementById('provider-select').value;
        const conf = PROVIDERS[p];
        const list = JSON.parse(localStorage.getItem(`${p}_model_list`)) || conf.models;
        
        const select = document.getElementById('model-select');
        select.innerHTML = "";
        list.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m; opt.innerText = m;
            select.appendChild(opt);
        });
        
        currentActiveModelId = localStorage.getItem(`${p}_model`) || conf.default;
        select.value = list.includes(currentActiveModelId) ? currentActiveModelId : list[0];
        
        if(reset) updateStatusBar(`å·²åˆ‡æ›è‡³ ${p}`);
    }

    async function saveSettings() {
        const p = document.getElementById('provider-select').value;
        const key = document.getElementById('api-key').value.trim();
        const model = document.getElementById('model-select').value;
        
        if(key) {
            const encrypted = await CryptoHelper.encrypt(key);
            localStorage.setItem(`${p}_key_enc`, encrypted);
        }
        
        localStorage.setItem('provider', p);
        localStorage.setItem(`${p}_model`, model);
        updateStatusBar("è¨­å®šå·²åŠ å¯†å„²å­˜", 'ready', true);
    }

    /** 
     * æ ¸å¿ƒï¼šPDF è™•ç†é‚è¼¯ (Gemini å…è²»ç‰ˆå„ªåŒ–)
     * - æ¯æ¬¡åƒ…è™•ç† 1 é  (Concurrency Queue = 1)
     * - æ¯é é–“éš” 10 ç§’
     * - åŠ å…¥æŒ‡æ•¸é€€é¿é‡è©¦
     */
    async function performPDFOCR(file, needTranslate) {
        const p = document.getElementById('provider-select').value;
        const key = document.getElementById('api-key').value;
        if(!key) { alert("è«‹å…ˆè¨­å®š API Key"); return; }

        updateStatusBar("PDF ä»»å‹™å•Ÿå‹•ï¼Œè«‹ç¨å€™...", 'busy', true); // ä»»å‹™å•Ÿå‹•èªéŸ³å…¬å‘Š
        
        try {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = "";

            for (let i = 1; i <= pdf.numPages; i++) {
                // é€²åº¦æ›´æ–°æ–¼ç‹€æ…‹åˆ—ï¼Œä½† announce è¨­ç‚º false é¿å…è¢å¹•é–±è®€å™¨æ¯é å ±æ™‚å¹²æ“¾
                updateStatusBar(`æ­£åœ¨è™•ç†ç¬¬ ${i} / ${pdf.numPages} é ...`, 'busy', false);
                
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 2.0 });
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = viewport.width; canvas.height = viewport.height;
                await page.render({ canvasContext: ctx, viewport }).promise;
                
                const imgBase64 = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
                
                // åŸ·è¡Œå–®é  OCR ä¸¦å¸¶æœ‰é‡è©¦æ©Ÿåˆ¶
                let pageContent = await callAIWithRetry(p, "è«‹è¾¨è­˜åœ–ä¸­æ‰€æœ‰æ–‡å­—ã€‚", imgBase64, "image/jpeg", key);
                fullText += `### ç¬¬ ${i} é \n${pageContent}\n\n`;
                
                // é‡‹æ”¾è¨˜æ†¶é«”
                canvas.remove();

                // Gemini å…è²»éšå±¤å¼·åˆ¶å»¶é² 10 ç§’
                if (i < pdf.numPages) {
                    for(let s = 10; s > 0; s--) {
                        updateStatusBar(`ç­‰å¾…å†·å»ä¸­ (${s}ç§’)...`, 'busy', false);
                        await sleep(1000);
                    }
                }
            }

            if(needTranslate) {
                updateStatusBar("æ­£åœ¨é€²è¡Œå…¨æ–‡ç¿»è­¯...", 'busy', true);
                fullText = await callAIWithRetry(p, `è«‹å°‡ä»¥ä¸‹æ–‡å­—ç¿»è­¯æˆç¹é«”ä¸­æ–‡ï¼š\n\n${fullText}`, null, null, key);
            }

            addMessage('assistant', fullText);
            updateStatusBar("PDF è™•ç†å®Œæˆï¼", 'ready', true); // çµæŸä»»å‹™èªéŸ³å…¬å‘Š

        } catch (e) {
            console.error(e);
            updateStatusBar("PDF è™•ç†å¤±æ•—", 'error', true);
        }
    }

    /** æŒ‡æ•¸é€€é¿é‡è©¦æ©Ÿåˆ¶ */
    async function callAIWithRetry(provider, text, file, mime, key, retries = 3) {
        const sys = "ä½ æ˜¯ä¸€ä½è¦–éšœåŠ©ç†ï¼Œè«‹ç²¾ç¢ºæä¾›æ–‡å­—å…§å®¹ã€‚";
        const model = document.getElementById('model-select').value;
        
        for (let attempt = 0; attempt < retries; attempt++) {
            try {
                let url, body, headers = { 'Content-Type': 'application/json' };
                
                if (provider === 'gemini') {
                    url = PROVIDERS.gemini.url.replace('{MODEL}', model).replace('{KEY}', key);
                    let parts = [{ text: text }];
                    if (file) parts.unshift({ inline_data: { mime_type: mime, data: file } });
                    body = { system_instruction: { parts: [{ text: sys }] }, contents: [{ role: "user", parts: parts }] };
                } else {
                    // å…¶ä»–æœå‹™å•†å¯¦ä½œ (OpenRouter/OpenAI)
                    url = PROVIDERS[provider].url;
                    headers['Authorization'] = `Bearer ${key}`;
                    let content = [{ type: "text", text: text }];
                    if (file) content.push({ type: "image_url", image_url: { url: `data:${mime};base64,${file}` } });
                    body = { model: model, messages: [{ role: "system", content: sys }, { role: "user", content: content }] };
                }

                const resp = await fetch(url, { method: 'POST', headers, body: JSON.stringify(body) });
                if (resp.status === 429) {
                    const wait = Math.pow(2, attempt) * 2000;
                    console.warn(`Rate limit. Retrying in ${wait}ms...`);
                    await sleep(wait);
                    continue;
                }
                
                const data = await resp.json();
                return provider === 'gemini' ? data.candidates[0].content.parts[0].text : data.choices[0].message.content;
            } catch (e) {
                if (attempt === retries - 1) throw e;
                await sleep(2000);
            }
        }
    }

    /** UI äº¤äº’å‡½æ•¸ */
    function handlePDFToolFileSelect() {
        const file = document.getElementById('pdf-tool-input').files[0];
        const translate = document.getElementById('pdf-translate').checked;
        if(file) performPDFOCR(file, translate);
    }

    async function handleSubmit() {
        const input = document.getElementById('user-input');
        const text = input.value.trim();
        if(!text) return;

        updateStatusBar("æ­£åœ¨å‚³é€å•é¡Œ...", 'busy', true);
        const key = document.getElementById('api-key').value;
        const p = document.getElementById('provider-select').value;

        addMessage('user', text);
        input.value = "";

        try {
            const res = await callAIWithRetry(p, text, null, null, key);
            addMessage('assistant', res);
            updateStatusBar("å›æ‡‰å·²é€é”", 'ready', true);
        } catch(e) {
            updateStatusBar("å‚³é€å¤±æ•—", 'error', true);
            addMessage('assistant', "æŠ±æ­‰ï¼Œé€£ç·šæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚è«‹æª¢æŸ¥ API Key æˆ–ç¶²è·¯ç‹€æ³ã€‚");
        }
    }

    function resetConversation() {
        document.getElementById('chat-output').innerHTML = "";
        chatHistory = [];
        updateStatusBar("å°è©±å·²æ¸…é™¤", 'ready', true);
    }

    window.addEventListener('pdfjs-loaded', () => {
        document.getElementById('pdf-start-btn').disabled = false;
        updateStatusBar("ç³»çµ±å·²æº–å‚™å°±ç·’");
    });

    // åˆå§‹åŒ–è¼‰å…¥
    document.addEventListener('DOMContentLoaded', initSettings);

    // å¿«æ·éµæ”¯æ´
    document.addEventListener('keydown', e => {
        if(e.altKey && e.shiftKey) {
            if(e.key.toLowerCase() === 's') document.getElementById('settings-area').open = !document.getElementById('settings-area').open;
            if(e.key.toLowerCase() === 'n') resetConversation();
        }
    });
</script>

</body>
</html>