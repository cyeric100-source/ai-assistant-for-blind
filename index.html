<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è¦–éšœåŠ©ç† (2025 å…¨èƒ½æ’ç‰ˆçµ‚æ¥µç‰ˆ)</title>
    
    <!-- å¼•å…¥æ ¸å¿ƒåº« -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/lib/marked.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>

    <script type="module">
        // ã€å®‰å…¨æ©Ÿåˆ¶ã€‘æœ¬æ©ŸåŸ·è¡Œæª¢æ¸¬èˆ‡é–å®š
        if (window.location.protocol === 'file:') {
            document.documentElement.innerHTML = `
                <body style="background:#000; color:#fff; display:flex; flex-direction:column; justify-content:center; align-items:center; height:100vh; margin:0; font-family:sans-serif;">
                    <h1 style="color:yellow; font-size:2.5rem; text-align:center;">âš ï¸ ç’°å¢ƒéŒ¯èª¤</h1>
                    <p style="font-size:1.5rem; text-align:center; max-width:800px; line-height:1.6;">
                        ç‚ºäº†ç¢ºä¿åŠŸèƒ½æ­£å¸¸ï¼Œæœ¬ç¨‹å¼ä¸æ”¯æ´åœ¨æœ¬æ©Ÿç›´æ¥é–‹å•Ÿã€‚<br>è«‹ä¸Šå‚³è‡³ GitHub Pages ä½¿ç”¨ã€‚
                    </p>
                </body>
            `;
            throw new Error("Local execution blocked.");
        }

        const PDF_BASE = './pdf-dist/pdf.mjs';
        const WORKER_URL = './pdf-dist/pdf.worker.mjs';

        async function initPdfSystem() {
            try {
                const response = await fetch(PDF_BASE, { method: 'HEAD' });
                if (!response.ok) throw new Error("æ‰¾ä¸åˆ° pdf-dist è³‡æ–™å¤¾");
                const pdfjsLib = await import(PDF_BASE);
                window.pdfjsLib = pdfjsLib;
                pdfjsLib.GlobalWorkerOptions.workerSrc = WORKER_URL;
                window.dispatchEvent(new Event('pdfjs-loaded'));
                window.logToDebug("INFO", "PDF æ ¸å¿ƒè¼‰å…¥æˆåŠŸ");
            } catch (e) {
                window.reportError("PDF ç³»çµ±åˆå§‹åŒ–å¤±æ•—", e);
            }
        }
        initPdfSystem();
    </script>
    
    <style>
        :root {
            --bg-color: #000000; --text-color: #FFFFFF; --accent-color: #FFFF00;
            --user-header-color: #0088ff; --ai-header-color: #FFFF00;
            --border-color: #555; --input-bg: #1A1A1A;
            --button-bg: #FFFF00; --button-text: #000000;
            --status-bg: #222; --tool-bg: #112233;
            --active-tab-bg: #004488; --active-tab-text: #ffffff;
        }

        body {
            font-family: system-ui, sans-serif;
            background-color: var(--bg-color); color: var(--text-color);
            margin: 0; padding: 60px 0 0 0; font-size: 1.2rem; line-height: 1.6;
            -webkit-user-select: none; user-select: none;
        }
        
        .message-area, textarea, input { -webkit-user-select: text; user-select: text; }

        .container { max-width: 900px; margin: 0 auto; padding: 10px 10px 450px 10px; }
        .app-title { font-size: 1.5rem; text-align: center; margin: 10px 0; color: #ccc; font-weight: bold; }
        
        input, select, textarea {
            width: 100%; padding: 12px; margin: 5px 0 10px 0;
            background: var(--input-bg); border: 2px solid var(--border-color);
            color: var(--text-color); font-size: 1.1rem; border-radius: 6px; box-sizing: border-box;
        }

        #system-prompt { min-height: 150px; }
        *:focus-visible { outline: 4px solid var(--accent-color) !important; }

        button {
            background-color: var(--button-bg); color: var(--button-text);
            border: 2px solid #fff; padding: 12px; font-size: 1.1rem; font-weight: bold;
            border-radius: 8px; cursor: pointer; touch-action: manipulation;
        }
        button:disabled { filter: grayscale(100%); opacity: 0.7; }
        button.secondary { background-color: #333; color: #fff; border-color: #777; }
        button.danger { background-color: #550000; color: #ffcccc; border-color: #ff4444; }
        button.tool-btn { background-color: #0066cc; color: white; border-color: #44aaff; }
        button.mini-copy-btn { background-color: #333; color: #fff; border: 1px solid #777; padding: 6px 12px; font-size: 0.9rem; margin-top: 10px; width: auto; }

        .settings-subsection { border: 1px solid #444; padding: 10px; border-radius: 6px; margin: 10px 0; background: #222; }
        .settings-subsection h3 { margin: 0 0 10px 0; font-size: 1.1rem; color: var(--accent-color); }

        .prompt-tabs { display: flex; gap: 2px; }
        .prompt-tabs button { flex: 1; border-radius: 0; background: #333; color: #aaa; font-size: 1rem; }
        .prompt-tabs button.active { background: var(--active-tab-bg); color: #fff; border-color: #fff; }

        details { border: 1px solid var(--border-color); padding: 10px; border-radius: 8px; margin-bottom: 10px; background: #111; }
        .message { background: #111; padding: 15px; margin-bottom: 25px; border-left: 5px solid var(--border-color); }
        .message:focus { outline: none; border-left-width: 8px; border-left-color: var(--accent-color); background: #222; }
        .message.user { border-left-color: var(--user-header-color); background: #0a0a1a; }
        .message.assistant { border-left-color: var(--ai-header-color); background: #1a1a0a; }

        .markdown-body { line-height: 1.7; overflow-wrap: break-word; }
        .markdown-body h2 { color: #88CCFF; margin-top: 1.2em; }

        .controls-wrapper { position: fixed; bottom: 0; left: 0; right: 0; background: #000; border-top: 3px solid var(--accent-color); padding: 10px; z-index: 100; }
        .row { display: flex; gap: 10px; margin-bottom: 8px; align-items: flex-end; }
        .check-btn { display: flex; align-items: center; justify-content: center; background: #222; border: 1px solid #555; padding: 10px; border-radius: 6px; flex: 1; cursor: pointer; }
        
        #status-bar-container { position: fixed; top: 0; left: 0; right: 0; z-index: 2000; display: flex; flex-direction: column; }
        #status-bar { background: var(--status-bg); color: #fff; padding: 10px; text-align: center; font-weight: bold; border-bottom: 2px solid var(--border-color); }
        #status-bar.ready { background: #004400; }
        #status-bar.busy { background: #664400; }
        #status-bar.error { background: #660000; }

        #visual-progress { background: #333; color: #88ccff; font-size: 0.9rem; text-align: center; display: none; }
        #visual-progress.active { display: block; }
        
        #debug-log-area { min-height: 120px; font-family: monospace; font-size: 0.85rem; background: #000; color: #00ff00; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="status-bar-container">
    <div id="status-bar" role="status" aria-live="polite" tabindex="-1">ç³»çµ±åˆå§‹åŒ–ä¸­...</div>
    <div id="visual-progress" aria-hidden="true"></div>
</div>

<div class="container">
    <h1 class="app-title">AI è¦–éšœåŠ©ç† (2025 å…¨èƒ½æ’ç‰ˆçµ‚æ¥µç‰ˆ)</h1>

    <details id="settings-area">
        <summary role="button" aria-expanded="false" id="settings-summary">
            <h2>è¨­å®š (Alt+Shift+S)</h2>
        </summary>
        <div style="margin-top: 15px;">
            <label for="provider-select">ä¸»è¦ AI æœå‹™å•†:</label>
            <select id="provider-select" onchange="handleProviderChange()">
                <option value="gemini">Google Gemini</option>
                <option value="openrouter">OpenRouter</option>
                <option value="openai">OpenAI</option>
                <option value="groq">Groq</option>
            </select>

            <label for="api-key">API Key:</label>
            <input type="password" id="api-key" placeholder="åœ¨æ­¤è²¼ä¸Š API Key" autocomplete="off">
            
            <label for="model-select">æ¨¡å‹é¸æ“‡:</label>
            <div class="row">
                <select id="model-select" onchange="handleModelSelectChange()"></select>
                <button type="button" onclick="fetchOnlineModels()" class="secondary">æ›´æ–°æ¸…å–®</button>
            </div>

            <div class="settings-subsection">
                <h3>ç³»çµ±æŒ‡ä»¤</h3>
                <div class="prompt-tabs">
                    <button type="button" id="tab-chat" class="active" onclick="switchPromptEditor('chat')">å°è©±</button>
                    <button type="button" id="tab-ocr" onclick="switchPromptEditor('ocr')">OCR</button>
                    <button type="button" id="tab-translate" onclick="switchPromptEditor('translate')">ç¿»è­¯</button>
                </div>
                <textarea id="system-prompt" placeholder="è¼¸å…¥æŒ‡ä»¤..."></textarea>
            </div>

            <!-- åµéŒ¯å€å¡Š (é è¨­éš±è—) -->
            <details style="border-color: #440000; background: #1a0000;">
                <summary style="color: #ff8888;">åµéŒ¯è¨ºæ–·æ—¥èªŒ (Debug Log)</summary>
                <textarea id="debug-log-area" readonly></textarea>
                <button type="button" onclick="copyDebugLog()" style="width:100%;" class="secondary">è¤‡è£½æ—¥èªŒä»¥ä¾›åˆ†æ</button>
            </details>

            <div class="row" style="margin-top:10px;">
                <button type="button" onclick="saveSettings()" style="flex:1;">å„²å­˜è¨­å®š</button>
                <button type="button" onclick="restoreDefaults()" class="secondary" style="flex:1;">é‚„åŸé è¨­</button>
            </div>
        </div>
    </details>

    <details class="pdf-tool-group" open>
        <summary role="button" aria-expanded="true"><h2>PDF æ™ºèƒ½å·¥å…·ç®±</h2></summary>
        <div style="margin-top: 15px;">
            <input type="file" id="pdf-tool-input" class="visually-hidden" accept="application/pdf" onchange="handlePDFToolFileSelect()">
            <button type="button" id="pdf-start-btn" class="tool-btn" style="width:100%;" onclick="document.getElementById('pdf-tool-input').click()" disabled>ğŸ“„ PDF å®Œæ•´é–±è®€ (è¼‰å…¥ä¸­...)</button>
            <div class="row" style="margin-top:10px;">
                <label class="check-btn"><input type="checkbox" id="pdf-always-ai"><span>å¼·åˆ¶ OCR</span></label>
                <label class="check-btn"><input type="checkbox" id="pdf-translate"><span>ç¿»è­¯å…¨æ–‡</span></label>
            </div>
        </div>
    </details>

    <main id="chat-output" class="message-area"></main>
</div>

<footer class="controls-wrapper">
    <form onsubmit="handleSubmit(event)">
        <div class="row">
            <button type="button" id="new-chat-btn" class="danger" onclick="resetConversation()" style="flex:1;">æ¸…é™¤å°è©±</button>
            <button type="button" id="copy-btn" class="secondary" onclick="copyResult()" style="flex:1;">è¤‡è£½å…¨æ–‡</button>
        </div>
        <div class="row">
            <button type="button" id="voice-btn" class="secondary" style="height:80px; width:100px;">æŒ‰ä½èªªè©±</button>
            <textarea id="user-input" placeholder="è¼¸å…¥è¨Šæ¯..." rows="3"></textarea>
            <button type="submit" id="submit-btn" style="height:80px; width:80px;">å‚³é€</button>
        </div>
    </form>
</footer>

<script>
    // --- 1. åµéŒ¯ç³»çµ± ---
    window.logToDebug = function(level, message, data = null) {
        const area = document.getElementById('debug-log-area');
        const time = new Date().toISOString().split('T')[1].split('.')[0];
        // é®è”½é‡‘é‘°ä¿è­·éš±ç§
        let dataStr = data ? JSON.stringify(data) : "";
        dataStr = dataStr.replace(/Bearer [a-zA-Z0-9]{3,6}[a-zA-Z0-9]+[a-zA-Z0-9]{3,6}/g, (m) => m.slice(0, 10) + "..." + m.slice(-4));
        const entry = `[${time}] ${level}: ${message} ${dataStr}\n`;
        area.value += entry;
        area.scrollTop = area.scrollHeight;
    };

    window.reportError = function(context, err) {
        window.logToDebug("ERROR", context, { message: err.message, stack: err.stack });
        let userMsg = "ç™¼ç”ŸéŒ¯èª¤";
        if (err.message.includes("401")) userMsg = "é‡‘é‘°ç„¡æ•ˆï¼Œè«‹æª¢æŸ¥è¨­å®šã€‚";
        else if (err.message.includes("429")) userMsg = "ç™¼é€å¤ªå¿«ï¼Œè«‹ç¨ç­‰å†è©¦ã€‚";
        else if (err.message.includes("fetch")) userMsg = "ç¶²è·¯é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥é€£ç¶²ç‹€æ…‹ã€‚";
        
        updateStatusBar(userMsg, "error");
        playAudioCue('error');
    };

    function copyDebugLog() {
        navigator.clipboard.writeText(document.getElementById('debug-log-area').value);
        showTransientStatus("æ—¥èªŒå·²è¤‡è£½");
    }

    // --- 2. æ ¸å¿ƒé‚è¼¯ ---
    class UniversalTextNormalizer {
        static getScriptType(c) {
            const code = c.charCodeAt(0);
            if (code >= 0x4E00 && code <= 0x9FFF) return 'cjk';
            if (code >= 0x0E00 && code <= 0x109F) return 'sea';
            if (code >= 0x0030 && code <= 0x007A) return 'latin';
            return 'other';
        }
        static normalize(t) {
            if (!t) return "";
            let res = t.replace(/\r\n/g, "\n").replace(/([a-zA-Z])-\n([a-zA-Z])/g, "$1$2");
            const lines = res.split("\n");
            let out = "";
            for (let i = 0; i < lines.length; i++) {
                let curr = lines[i].trim();
                if (!curr) { out += "\n\n"; continue; }
                if (i < lines.length - 1) {
                    let next = lines[i+1].trim();
                    const typeA = this.getScriptType(curr.slice(-1)), typeB = this.getScriptType(next.charAt(0));
                    if ((typeA === 'cjk' || typeA === 'sea') && (typeB === 'cjk' || typeB === 'sea')) out += curr;
                    else if ((typeA === 'cjk' && typeB === 'latin') || (typeA === 'latin' && typeB === 'cjk')) out += curr;
                    else out += curr + " ";
                } else out += curr;
            }
            return out.replace(/\s+([,.:;?!])/g, "$1").trim();
        }
    }

    // --- 3. é‡è©¦æ©Ÿåˆ¶ ---
    async function callAIWithRetry(p, txt, file, mime, sig, model, key, sys) {
        let lastError = null;
        for (let attempt = 0; attempt <= 1; attempt++) {
            try {
                if (attempt === 1) {
                    window.logToDebug("RETRY", "åŸ·è¡Œç¬¬ 1 æ¬¡é‡è©¦");
                    updateStatusBar("ç¶²è·¯é€£ç·šä¸ç©©å®šï¼Œæ­£åœ¨é€²è¡Œç¬¬ 1 æ¬¡é‡è©¦...", "busy");
                    await sleep(2000); // æŒ‡æ•¸é€€é¿å»¶é²
                }
                return await callAI(p, txt, file, mime, sig, model, key, sys);
            } catch (e) {
                lastError = e;
                if (attempt === 0 && (e.message.includes("fetch") || e.status === 503)) {
                    continue; // åƒ…é‡å°ç¶²è·¯æˆ–ä¼ºæœå™¨éŒ¯èª¤é‡è©¦
                }
                break;
            }
        }
        throw lastError;
    }

    // --- 4. ä»‹é¢è¼”åŠ© ---
    function updateStatusBar(t, s='ready') {
        const b = document.getElementById('status-bar');
        b.innerText = t; b.className = s;
        b.setAttribute('aria-live', s === 'error' ? 'assertive' : 'polite');
    }

    function addMessage(role, content) {
        const div = document.createElement('div');
        div.className = `message ${role}`; div.tabIndex = -1;
        div.innerHTML = `<h1 class="msg-heading">${role==='user'?'å•é¡Œï¼š':'å›æ‡‰ï¼š'}</h1><div class="markdown-body" dir="auto">${role==='user'?content:DOMPurify.sanitize(marked.parse(content))}</div>`;
        document.getElementById('chat-output').appendChild(div);
        setTimeout(() => div.focus(), 150);
        return div;
    }

    // --- 5. PDF è™•ç† ---
    async function processPDFTool(file) {
        updateStatusBar("åˆ†ææª”æ¡ˆä¸­...", "busy");
        window.logToDebug("INFO", "é–‹å§‹è™•ç† PDF", { name: file.name, size: file.size });
        try {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let pageTexts = [];
            const isOCR = document.getElementById('pdf-always-ai').checked;
            
            for (let i = 1; i <= pdf.numPages; i++) {
                updateVisualProgress(true, `è™•ç†ä¸­: ${i}/${pdf.numPages}`);
                const page = await pdf.getPage(i);
                let text = "";
                if (!isOCR) {
                    const content = await page.getTextContent();
                    text = UniversalTextNormalizer.normalize(content.items.map(it => it.str).join(' '));
                }
                // è‹¥æ–‡å­—å¤ªå°‘å‰‡è‡ªå‹•è§¸ç™¼ OCR (æ¨¡æ“¬è¦–è¦º)
                if (text.length < 20 || isOCR) {
                    window.logToDebug("DEBUG", `ç¬¬ ${i} é æ”¹ç”¨ OCR`);
                    const viewport = page.getViewport({ scale: 1.5 });
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = viewport.width; canvas.height = viewport.height;
                    await page.render({ canvasContext: ctx, viewport }).promise;
                    text = await callAIWithRetry(document.getElementById('provider-select').value, "OCR this page.", canvas.toDataURL('image/jpeg', 0.6).split(',')[1], "image/jpeg", null, null, null, "Extract text verbatim.");
                }
                pageTexts.push(`## [Page ${i}]\n${text}`);
            }
            
            const combined = pageTexts.join("\n\n");
            if (document.getElementById('pdf-translate').checked) {
                const translated = await callAIWithRetry(document.getElementById('provider-select').value, combined, null, null, null, null, null, "Translate to Traditional Chinese.");
                addMessage('assistant', translated);
            } else {
                addMessage('assistant', combined);
            }
            updateStatusBar("è™•ç†å®Œæˆ");
        } catch (e) {
            window.reportError("PDF è™•ç†ä¸­æ–·", e);
        } finally { updateVisualProgress(false); }
    }

    // --- 6. é€šç”¨å‡½æ•¸ ---
    const DEFAULT_CHAT_PROMPT = `ä½ æ˜¯ä¸€ä½é¦™æ¸¯è¦–éšœåŠ©ç†ã€‚è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡ã€Markdown æ ¼å¼å›ç­”ï¼Œä¸¦ä¿æŒç°¡æ½”ã€‚`;
    let memoryPrompts = { chat: DEFAULT_CHAT_PROMPT, ocr: "Extract text from image.", translate: "Translate to Traditional Chinese." };
    let currentEditingMode = 'chat';

    async function callAI(p, txt, file, mime, sig, model, key, sys) {
        const apiKey = key || document.getElementById('api-key').value;
        const mdl = model || document.getElementById('model-select').value;
        if (!apiKey) throw new Error("401: ç„¡ API Key");
        
        window.logToDebug("NETWORK", `è«‹æ±‚ AI (${p})`, { model: mdl });
        let url = "", body = {}, headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` };

        if (p === 'gemini') {
            url = `https://generativelanguage.googleapis.com/v1beta/models/${mdl}:generateContent?key=${apiKey}`;
            delete headers['Authorization'];
            body = { system_instruction: { parts: [{ text: sys }] }, contents: [{ role: "user", parts: file ? [{ inline_data: { mime_type: mime, data: file } }, { text: txt }] : [{ text: txt }] }] };
        } else {
            url = "https://openrouter.ai/api/v1/chat/completions";
            body = { model: mdl, messages: [{ role: "system", content: sys }, { role: "user", content: file ? [{ type: "text", text: txt }, { type: "image_url", image_url: { url: `data:${mime};base64,${file}` } }] : txt }] };
        }

        const res = await fetch(url, { method: 'POST', headers, body: JSON.stringify(body), signal: sig });
        if (!res.ok) {
            const errData = await res.text();
            const error = new Error(`API Error ${res.status}`);
            error.status = res.status; error.details = errData;
            throw error;
        }
        const data = await res.json();
        return p === 'gemini' ? data.candidates[0].content.parts[0].text : data.choices[0].message.content;
    }

    async function handleSubmit(e) {
        e.preventDefault();
        const txt = document.getElementById('user-input').value.trim();
        if (!txt) return;
        updateStatusBar("æ€è€ƒä¸­...", "busy");
        try {
            const res = await callAIWithRetry(document.getElementById('provider-select').value, txt, null, null, null, null, null, document.getElementById('system-prompt').value);
            addMessage('user', txt);
            addMessage('assistant', res);
            document.getElementById('user-input').value = "";
            updateStatusBar("æº–å‚™å°±ç·’");
        } catch (e) {
            window.reportError("å‚³é€å¤±æ•—", e);
        }
    }

    // åˆå§‹åŒ–èˆ‡å…¶é¤˜è¼”åŠ© UI ä»£ç¢¼... (æ¯”ç…§èˆŠç‰ˆçµæ§‹)
    function handleProviderChange() {
        const p = document.getElementById('provider-select').value;
        const keys = { gemini: "gemini-2.0-flash", openrouter: "google/gemini-2.0-flash-001" };
        const sel = document.getElementById('model-select');
        sel.innerHTML = `<option value="${keys[p]}">${keys[p]}</option>`;
        document.getElementById('system-prompt').value = memoryPrompts.chat;
    }
    
    function updateVisualProgress(show, text="") {
        const el = document.getElementById('visual-progress');
        el.className = show ? 'active' : ''; el.innerText = text;
    }

    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
    function playAudioCue(t) { /* æ’­æ”¾éŸ³æ•ˆ */ }
    function resetConversation() { document.getElementById('chat-output').innerHTML = ""; }
    function saveSettings() { showTransientStatus("è¨­å®šå·²å„²å­˜"); }
    function showTransientStatus(m) { updateStatusBar(m); setTimeout(() => updateStatusBar("æº–å‚™å°±ç·’"), 3000); }
    function handlePDFToolFileSelect() { const f = document.getElementById('pdf-tool-input').files[0]; if(f) processPDFTool(f); }
    window.addEventListener('pdfjs-loaded', () => { document.getElementById('pdf-start-btn').disabled = false; document.getElementById('pdf-start-btn').innerText = "ğŸ“„ PDF å®Œæ•´é–±è®€ (æœ¬åœ°æ ¸å¿ƒå°±ç·’)"; });

</script>
</body>
</html>