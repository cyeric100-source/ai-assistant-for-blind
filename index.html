<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI è¦–éšœåŠ©ç† - æ–‡å­—è®€å–å°ˆå®¶</title>
    
    <!-- å¼•å…¥ Marked.js è§£æ Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/lib/marked.umd.min.js"></script>
    
    <!-- å¼•å…¥ DOMPurify é€²è¡Œ HTML æ¶ˆæ¯’ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>

    <!-- ã€æ ¸å¿ƒè¨­å®šã€‘PDF.js v4.0.379 (ä½¿ç”¨ç©©å®šç‰ˆæœ¬) -->
    <script type="module">
        if (window.location.protocol === 'file:') {
            document.documentElement.innerHTML = `
                <body style="background:#000; color:#fff; display:flex; flex-direction:column; justify-content:center; align-items:center; height:100vh; margin:0; font-family:sans-serif;">
                    <h1 style="color:yellow; font-size:2.5rem; text-align:center;">âš ï¸ ç’°å¢ƒéŒ¯èª¤</h1>
                    <p style="font-size:1.5rem; text-align:center; max-width:800px; line-height:1.6;">
                        è«‹å°‡æ­¤å°ˆæ¡ˆä¸Šå‚³è‡³ <strong>GitHub</strong> ä¸¦é€é GitHub Pages é–‹å•Ÿã€‚
                    </p>
                </body>
            `;
            throw new Error("Local execution blocked.");
        }

        const PDF_BASE = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.mjs';
        const WORKER_URL = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.mjs';

        async function initPdfSystem() {
            try {
                const pdfjsLib = await import(PDF_BASE);
                window.pdfjsLib = pdfjsLib;
                pdfjsLib.GlobalWorkerOptions.workerSrc = WORKER_URL;
                console.log("PDF System Initialized");
                window.dispatchEvent(new Event('pdfjs-loaded'));
            } catch (e) {
                console.error("PDF Init Failed:", e);
                window.reportError("PDF æ ¸å¿ƒè¼‰å…¥å¤±æ•— (CDN)", e);
                // ç”±æ–¼æŒ‰éˆ•IDå·²è®Šæ›´ï¼Œé€™è£¡åšé€šç”¨è™•ç†
                const btns = document.querySelectorAll('button');
                btns.forEach(b => {
                    if(b.textContent.includes('åˆ†æ')) b.disabled = true;
                });
            }
        }
        initPdfSystem();
    </script>
    
    <style>
        :root {
            --bg-color: #000000;
            --text-color: #FFFFFF;
            --accent-color: #FFFF00;
            --user-header-color: #0088ff;
            --ai-header-color: #FFFF00;
            --border-color: #555;
            --input-bg: #1A1A1A;
            --button-bg: #FFFF00;
            --button-text: #000000;
            --status-bg: #222;
            --tool-bg: #112233;
            --nav-bg: #111;
            --nav-active-bg: #333;
        }

        /* å…¨å±€é‡ç½®èˆ‡ä½ˆå±€ */
        * { box-sizing: border-box; }
        
        body {
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 0;
            font-size: 1.1rem; line-height: 1.5;
            height: 100dvh;
            display: grid;
            grid-template-rows: auto 1fr auto;
            overflow: hidden;
        }

        /* 1. é ‚éƒ¨ç‹€æ…‹åˆ— */
        header {
            background: var(--status-bg);
            border-bottom: 1px solid var(--border-color);
            z-index: 100;
            flex-shrink: 0;
        }

        #status-bar {
            padding: 8px; text-align: center; font-weight: bold;
            font-size: 1rem; color: #fff;
            transition: background-color 0.3s;
        }
        #status-bar.ready { background: #004400; }
        #status-bar.busy { background: #664400; }
        #status-bar.error { background: #660000; }
        
        #visual-progress {
            background: #333; color: #88ccff; font-size: 0.85rem; 
            text-align: center; padding: 2px; display: none;
        }
        #visual-progress.active { display: block; }

        /* 2. ä¸»å…§å®¹å€åŸŸ (Tab Views) */
        main {
            position: relative;
            overflow: hidden;
            background: var(--bg-color);
        }

        .view-section {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            overflow-y: auto;
            padding: 15px;
            display: none;
            flex-direction: column;
        }

        .view-section.active {
            display: flex;
        }
        
        /* [Chat View] ç‰¹åˆ¥ä½ˆå±€ */
        #view-chat {
            padding: 0; 
        }
        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 20px;
        }
        #input-area-wrapper {
            flex-shrink: 0;
            background: #111;
            border-top: 1px solid var(--border-color);
            padding: 10px;
        }

        /* 3. åº•éƒ¨å°èˆªæ¬„ */
        .bottom-nav {
            background: var(--nav-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 70px;
            flex-shrink: 0;
            z-index: 200;
        }

        .nav-btn {
            background: transparent; border: none;
            color: #888;
            font-size: 0.9rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            height: 100%;
            cursor: pointer;
            padding: 5px;
        }
        .nav-btn span.icon { font-size: 1.5rem; margin-bottom: 4px; display: block; }
        .nav-btn.active {
            color: var(--accent-color);
            background: var(--nav-active-bg);
            border-top: 3px solid var(--accent-color);
        }
        .nav-btn:focus-visible { outline: 3px solid var(--accent-color); box-shadow: inset 0 0 10px #fff; }

        /* é€šç”¨å…ƒä»¶æ¨£å¼ */
        h2 { 
            font-size: 1.3rem; color: #88ccff; border-bottom: 2px solid #333; 
            padding-bottom: 5px; margin-top: 0; margin-bottom: 15px;
        }
        h3 { color: #ccc; margin: 15px 0 10px 0; font-size: 1.1rem; }

        input, select, textarea {
            width: 100%; padding: 12px; margin-bottom: 15px;
            background: var(--input-bg); border: 1px solid var(--border-color);
            color: var(--text-color); font-size: 1.1rem; border-radius: 6px;
        }
        
        button.action-btn {
            width: 100%; padding: 14px; font-size: 1.1rem; font-weight: bold;
            border-radius: 8px; margin-bottom: 12px; cursor: pointer;
            background-color: var(--button-bg); color: var(--button-text); border: none;
        }
        button.secondary { background-color: #333; color: #fff; border: 1px solid #777; }
        button.danger { background-color: #550000; color: #ffcccc; border: 1px solid #ff4444; }
        button.high-contrast { background-color: #FFD700; color: #000; border: 2px solid #FFF; font-size: 1.2rem; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* å°è©±æ°£æ³¡æ¨£å¼ */
        .message {
            background: #111; padding: 15px; margin-bottom: 20px;
            border-left: 5px solid var(--border-color);
            border-radius: 4px;
        }
        .message.user { border-left-color: var(--user-header-color); background: #0a0a1a; }
        .message.assistant { border-left-color: var(--ai-header-color); background: #1a1a0a; }
        .message h1.msg-heading { font-size: 1rem; color: #888; margin: 0 0 5px 0; border: none; }
        
        /* è¼¸å…¥å€æ¨£å¼ */
        .input-row { display: flex; gap: 8px; align-items: flex-end; }
        #user-input { min-height: 60px; max-height: 150px; margin-bottom: 0; resize: none; }
        #submit-btn { width: 90px; height: 60px; margin: 0; flex-shrink: 0; padding: 5px; font-size: 1rem; }
        
        /* Utility Row & Checkbox */
        .utility-row { display: flex; gap: 10px; margin-bottom: 10px; overflow-x: auto; padding-bottom: 5px; align-items: center; }
        .utility-row button { white-space: nowrap; font-size: 0.9rem; padding: 8px 12px; margin: 0; width: auto; flex-shrink: 0; }

        /* æ¨™æº– Checkbox æ¨£å¼ (å°è©±é å°ˆç”¨) */
        .chat-check-btn {
            display: inline-flex; align-items: center;
            background: #333; border: 1px solid #777; color: #fff;
            padding: 8px 12px; border-radius: 6px;
            font-size: 0.9rem; cursor: pointer; white-space: nowrap;
            user-select: none;
        }
        .chat-check-btn input {
            width: 18px; height: 18px; margin: 0 8px 0 0;
            accent-color: var(--accent-color); /* å¼·èª¿è‰² */
        }
        .chat-check-btn:has(input:checked) {
            border-color: var(--accent-color);
            background: #2a2a00;
        }

        /* è¨­å®šé èˆ‡å·¥å…·é å¡ç‰‡æ¨£å¼ */
        .settings-card {
            background: #1a1a1a; padding: 15px; border-radius: 8px;
            border: 1px solid #333; margin-bottom: 20px;
        }
        
        .check-btn {
            display: flex; align-items: center; background: #222; padding: 10px;
            border-radius: 6px; margin-bottom: 10px; border: 1px solid #444;
            cursor: pointer;
        }
        /* é¸ä¸­æ™‚é«˜äº®å·¥å…·é çš„ Radio */
        .check-btn:has(input:checked) {
            border-color: var(--accent-color);
            background: #2a2a00;
        }
        .check-btn input { width: 25px; height: 25px; margin: 0 10px 0 0; accent-color: var(--accent-color); }

        .hidden { display: none !important; }
        .visually-hidden { position: absolute; width: 1px; height: 1px; overflow: hidden; clip: rect(0,0,0,0); }
        
        /* é›»è…¦ç‰ˆé©é…ï¼šå´é‚Šæ¬„ */
        @media (min-width: 768px) {
            body {
                grid-template-rows: auto 1fr;
                grid-template-columns: 200px 1fr;
            }
            header { grid-column: 1 / -1; }
            .bottom-nav {
                grid-row: 2; grid-column: 1;
                flex-direction: column; justify-content: flex-start;
                height: 100%; padding-top: 20px;
                border-top: none; border-right: 1px solid var(--border-color);
            }
            .nav-btn { height: auto; padding: 20px; width: 100%; border-top: none; border-left: 4px solid transparent; }
            .nav-btn.active { border-top: none; border-left-color: var(--accent-color); }
            main { grid-row: 2; grid-column: 2; }
        }
    </style>
</head>
<body>

    <!-- 1. é ‚éƒ¨ç‹€æ…‹ -->
    <header role="banner">
        <div id="status-bar" role="status" aria-live="polite">ç³»çµ±å·²å•Ÿå‹•ï¼Œè«‹é¸æ“‡åŠŸèƒ½</div>
        <div id="visual-progress" aria-hidden="true"></div>
    </header>

    <!-- 2. ä¸»å…§å®¹å€ (åŒ…å«ä¸‰å€‹è¦–åœ–) -->
    <main>
        <!-- A. å°è©±è¦–åœ– (Chat View) -->
        <section id="view-chat" class="view-section active" role="tabpanel" aria-labelledby="tab-chat">
            <div id="chat-container">
                <div class="message assistant">
                    <h1 class="msg-heading">AI åŠ©ç†ï¼š</h1>
                    <div class="markdown-body">ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI è¦–éšœåŠ©ç†ã€‚å·²å•Ÿç”¨å…¨åŠŸèƒ½å®‰å…¨ä»£ç† (æ”¯æ´å¤§å‹æª”æ¡ˆ)ã€‚è«‹è¼¸å…¥æ–‡å­—æˆ–ä¸Šå‚³åœ–ç‰‡/PDFé€²è¡Œå°è©±ã€‚</div>
                </div>
                <div id="chat-output"></div>
            </div>

            <!-- è¼¸å…¥æ§åˆ¶å€ -->
            <div id="input-area-wrapper">
                <div class="utility-row">
                    <button type="button" id="upload-btn" class="secondary" onclick="document.getElementById('file-input').click()">ğŸ“ æª”æ¡ˆ/æ‹ç…§</button>
                    <label class="chat-check-btn">
                        <input type="checkbox" id="pause-send">
                        <span>æš«åœç™¼é€</span>
                    </label>
                    <button type="button" id="new-chat-btn" class="danger" onclick="resetConversation()">ğŸ—‘ï¸ æ¸…é™¤</button>
                    <input type="file" id="file-input" class="visually-hidden" accept="*/*" onchange="handleFileSelect()">
                </div>
                <form onsubmit="handleSubmit(event)" class="input-row">
                    <textarea id="user-input" placeholder="è¼¸å…¥è¨Šæ¯..." rows="1" aria-label="è¼¸å…¥è¨Šæ¯å€"></textarea>
                    <button type="submit" id="submit-btn" title="ç™¼é€">å‚³é€</button>
                </form>
            </div>
        </section>

        <!-- B. å·¥å…·è¦–åœ– (Tools View - ä»‹é¢é‡æ§‹) -->
        <section id="view-tools" class="view-section" role="tabpanel" aria-labelledby="tab-tools">
            <h2 tabindex="-1" id="tools-title">æ–‡å­—è®€å– (Reader)</h2>
            
            <!-- æ¨¡å¼é¸æ“‡ -->
            <div class="settings-card" style="border-color: var(--accent-color);">
                <h3>1. é¸æ“‡æ¨¡å¼</h3>
                <fieldset style="border:none; padding:0; margin:0;">
                    <label class="check-btn" style="margin-bottom:8px;">
                        <input type="radio" name="reader-mode" value="chandra">
                        <span style="font-weight:bold;">Chandra OCR (Datalab)</span>
                    </label>
                    <label class="check-btn" style="margin-bottom:8px;">
                        <input type="radio" name="reader-mode" value="hybrid" checked>
                        <span style="font-weight:bold;">å­—ç¬¦è®€å– + OCR (æ··åˆç²¾æº–)</span>
                    </label>
                    <label class="check-btn" style="margin-bottom:0;">
                        <input type="radio" name="reader-mode" value="visual">
                        <span style="font-weight:bold;">åªç”¨ OCR (ç´”è¦–è¦º)</span>
                    </label>
                </fieldset>
                <p style="font-size:0.9rem; color:#aaa; margin-top:10px;">
                    * æ··åˆç²¾æº–æ¨¡å¼ï¼šé©åˆ PDF æ–‡ä»¶ï¼ŒåŒæ™‚è®€å–æ–‡å­—å±¤èˆ‡é€²è¡Œè¦–è¦ºåˆ†æã€‚<br>
                    * è‹¥ä¸Šå‚³åœ–ç‰‡ï¼Œå°‡è‡ªå‹•åˆ‡æ›ç‚ºã€Œåªç”¨ OCRã€ã€‚
                </p>
            </div>

            <!-- æ“ä½œå€åŸŸ -->
            <div class="settings-card">
                <h3>2. åŸ·è¡Œæ“ä½œ</h3>
                <input type="file" id="tool-file-input" class="visually-hidden" accept="image/*,application/pdf" onchange="handleToolFileSelect()">
                
                <button type="button" class="action-btn high-contrast" onclick="document.getElementById('tool-file-input').click()">
                    ğŸ“¸ æ‹æ” / é¸æ“‡æª”æ¡ˆä¸¦åˆ†æ
                </button>
                
                <div style="margin-top:10px;">
                    <label class="check-btn">
                        <input type="checkbox" id="tool-translate"> <span>åˆ†æå¾Œç¿»è­¯æˆç¹é«”ä¸­æ–‡</span>
                    </label>
                </div>
            </div>

            <div class="settings-card">
                <h3>ğŸ’¾ è³‡æ–™åŒ¯å‡º (Export)</h3>
                <button type="button" id="copy-btn" class="action-btn secondary hidden" onclick="copyResult()">è¤‡è£½å…¨éƒ¨å°è©±</button>
                <button type="button" id="export-txt-btn" class="action-btn secondary hidden" onclick="exportChat('txt')">åŒ¯å‡ºç‚º TXT</button>
                <button type="button" id="export-html-btn" class="action-btn secondary hidden" onclick="exportChat('html')">åŒ¯å‡ºç‚º HTML</button>
                <p style="color:#777; font-size:0.9rem;">* åŒ¯å‡ºæŒ‰éˆ•å°‡åœ¨æœ‰å°è©±å…§å®¹å¾Œé¡¯ç¤ºã€‚</p>
            </div>
        </section>

        <!-- C. è¨­å®šè¦–åœ– (Settings View) -->
        <section id="view-settings" class="view-section" role="tabpanel" aria-labelledby="tab-settings">
            <h2 tabindex="-1" id="settings-title">ç³»çµ±è¨­å®š (Settings)</h2>

            <div id="settings-area">
                <div class="settings-card">
                    <h3>ğŸ¤– AI å°è©±æ¨¡å‹è¨­å®š</h3>
                    <div style="background: #442200; color: #ffcc88; padding: 8px; border-radius: 4px; margin-bottom: 10px; font-size: 0.9rem;">
                        âš ï¸ 2025 æç¤ºï¼šæ¨è–¦ä½¿ç”¨ Google Gemini æˆ– OpenRouterã€‚
                    </div>
                    
                    <label>ä¸»è¦æœå‹™å•† (å°è©±/åˆ†æ):</label>
                    <select id="provider-select" onchange="handleProviderChange(true)">
                        <option value="gemini">Google Gemini (æ¨è–¦)</option>
                        <option value="openrouter">OpenRouter (æ¨è–¦)</option>
                        <option value="openai">OpenAI</option>
                        <option value="groq">Groq</option>
                        <option value="mistral">Mistral AI</option>
                        <option value="perplexity">Perplexity</option>
                    </select>

                    <label>å°è©± AI API Key:</label>
                    <input type="password" id="api-key" placeholder="åœ¨æ­¤è²¼ä¸Šæ‚¨çš„ API Key" autocomplete="off">
                    
                    <label>æ¨¡å‹éæ¿¾:</label>
                    <input type="text" id="model-filter-input" placeholder="è¼¸å…¥é—œéµå­—ç¯©é¸..." oninput="handleModelFilter()">
                    
                    <label>é¸æ“‡æ¨¡å‹:</label>
                    <div style="display:flex; gap:10px;">
                        <select id="model-select" onchange="handleModelSelectChange()" style="margin-bottom:0;"></select>
                        <button type="button" id="refresh-btn" class="secondary" onclick="fetchOnlineModels()" style="width:auto; margin:0;">æ›´æ–°</button>
                    </div>
                    <div id="custom-model-wrapper" class="hidden" style="margin-top:10px;">
                        <input type="text" id="custom-model-input" placeholder="æ‰‹å‹•è¼¸å…¥æ¨¡å‹ ID" onchange="handleCustomInputChange()">
                    </div>
                </div>

                <!-- Chandra OCR å°ˆå±¬è¨­å®š -->
                <div class="settings-card" style="border-left: 5px solid #ff00ff;">
                    <h3>ğŸ“¸ Chandra OCR è¨­å®š (Datalab)</h3>
                    <p style="font-size:0.9rem; color:#ccc;">æ­¤è¨­å®šå°ˆç”¨æ–¼ã€Œæ–‡å­—è®€å–ã€åŠŸèƒ½ä¸­çš„ Chandra æ¨¡å¼ã€‚</p>
                    
                    <label>Datalab API Key:</label>
                    <input type="password" id="datalab-key" placeholder="åœ¨æ­¤è¼¸å…¥ Chandra / Datalab API Key">
                    
                    <label>è¾¨è­˜ç²¾ç¢ºåº¦ (Accuracy):</label>
                    <select id="datalab-mode">
                        <option value="fast">å¿«é€Ÿ (Fast)</option>
                        <option value="balanced" selected>å¹³è¡¡ (Balanced)</option>
                        <option value="accurate">é«˜ç²¾ç¢ºåº¦ (Accurate) - è²»ç”¨è¼ƒé«˜</option>
                    </select>
                </div>

                <div class="settings-card">
                    <h3>ğŸ› ï¸ ä»»å‹™åˆ†å·¥ (Task Assignment)</h3>
                    <div style="display:flex; flex-wrap:wrap; gap:10px;">
                        <button type="button" class="secondary" onclick="setSpecificConfig('ocr')" style="flex:1;">è¨­ç‚º OCR å°ˆç”¨</button>
                        <button type="button" class="secondary" onclick="setSpecificConfig('translate')" style="flex:1;">è¨­ç‚º ç¿»è­¯ å°ˆç”¨</button>
                        <button type="button" class="danger" onclick="clearSpecificConfigs()" style="flex:1;">é‡ç½®åˆ†å·¥</button>
                    </div>
                    <div id="config-status-display" aria-live="polite" style="margin-top:10px; color:#aaa; font-size:0.9rem;"></div>
                </div>

                <div class="settings-card">
                    <h3>âŒ¨ï¸ æ“ä½œè¨­å®š</h3>
                    <label class="check-btn">
                        <input type="checkbox" id="enter-to-send" checked> <span>æŒ‰ Enter éµå‚³é€</span>
                    </label>
                    <label class="check-btn" id="openrouter-settings" class="hidden">
                        <input type="checkbox" id="openrouter-web-search"> <span>å•Ÿç”¨è¯ç¶²æœå°‹ (OpenRouter)</span>
                    </label>
                    
                    <label>å›æ‡‰é€¾æ™‚ (ç§’):</label>
                    <input type="number" id="timeout-setting" value="120">
                </div>

                <div class="settings-card">
                    <h3>ğŸ“ ç³»çµ±æŒ‡ä»¤ (System Prompts)</h3>
                    <div class="utility-row">
                        <button type="button" id="tab-chat" class="secondary" onclick="switchPromptEditor('chat')">ä¸€èˆ¬å°è©±</button>
                        <button type="button" id="tab-ocr" class="secondary" onclick="switchPromptEditor('ocr')">OCR å°ˆç”¨</button>
                        <button type="button" id="tab-translate" class="secondary" onclick="switchPromptEditor('translate')">ç¿»è­¯å°ˆç”¨</button>
                    </div>
                    <textarea id="system-prompt" rows="5" placeholder="åœ¨æ­¤è¼¸å…¥ç³»çµ±æŒ‡ä»¤..."></textarea>
                </div>

                <div class="settings-card" style="border-color: #550000;">
                    <h3>ğŸ› éŒ¯èª¤æ—¥èªŒ (Debug)</h3>
                    <textarea id="error-log-area" readonly rows="5" placeholder="ç„¡éŒ¯èª¤"></textarea>
                    <button type="button" class="secondary" onclick="copyErrorLog()">è¤‡è£½æ—¥èªŒ</button>
                </div>

                <button type="button" class="action-btn" onclick="saveSettings()">å„²å­˜æ‰€æœ‰è¨­å®š</button>
                <button type="button" class="action-btn secondary" onclick="restoreDefaults()">æ¢å¾©é è¨­å€¼</button>
            </div>
        </section>
    </main>

    <!-- 3. åº•éƒ¨å°èˆªæ¬„ -->
    <nav class="bottom-nav" role="tablist">
        <button type="button" class="nav-btn active" id="nav-chat" role="tab" aria-selected="true" aria-controls="view-chat" onclick="switchTab('chat')">
            <span class="icon">ğŸ’¬</span>
            <span>å°è©±</span>
        </button>
        <button type="button" class="nav-btn" id="nav-tools" role="tab" aria-selected="false" aria-controls="view-tools" onclick="switchTab('tools')">
            <span class="icon">ğŸ› ï¸</span>
            <span>æ–‡å­—è®€å–</span>
        </button>
        <button type="button" class="nav-btn" id="nav-settings" role="tab" aria-selected="false" aria-controls="view-settings" onclick="switchTab('settings')">
            <span class="icon">âš™ï¸</span>
            <span>è¨­å®š</span>
        </button>
    </nav>

    <script>
        // --- æ ¸å¿ƒè®Šæ•¸ï¼šCloudflare Worker ä»£ç† ---
        const USER_WORKER_URL = "https://ai-helper-for-blind.cyeric20.workers.dev/";

        // --- å…¨åŸŸè®Šæ•¸ ---
        let stickyMemory = { type: null, content: null, mime: null, count: 0 };
        let lastActiveTabId = 'chat'; 
        let audioContext = null; 
        
        // --- æ ¸å¿ƒ 1: åˆ†é åˆ‡æ›é‚è¼¯ ---
        function switchTab(tabId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => {
                el.classList.remove('active');
                el.setAttribute('aria-selected', 'false');
            });

            const targetView = document.getElementById(`view-${tabId}`);
            const targetNav = document.getElementById(`nav-${tabId}`);
            
            if (targetView && targetNav) {
                targetView.classList.add('active');
                targetNav.classList.add('active');
                targetNav.setAttribute('aria-selected', 'true');
                if (tabId === 'chat') document.getElementById('user-input').focus();
                else { const title = document.getElementById(`${tabId}-title`); if (title) title.focus(); }
            }
            
            if (tabId !== 'settings') {
                lastActiveTabId = tabId;
            }
        }

        // --- æ ¸å¿ƒ 2: è¼”åŠ©é¡åˆ¥ ---
        class UniversalTextNormalizer {
            static getScriptType(char) {
                if (!char) return 'other';
                const code = char.charCodeAt(0);
                if ((code >= 0x4E00 && code <= 0x9FFF) || (code >= 0x3040 && code <= 0x30FF) || (code >= 0xAC00 && code <= 0xD7AF)) return 'cjk';
                if ((code >= 0x0E00 && code <= 0x0E7F) || (code >= 0x1780 && code <= 0x17FF)) return 'sea';
                if ((code >= 0x0600 && code <= 0x06FF) || (code >= 0x0590 && code <= 0x05FF)) return 'rtl';
                if ((code >= 0x0041 && code <= 0x005A) || (code >= 0x0061 && code <= 0x007A) || (code >= 0x0030 && code <= 0x0039) || (code >= 0x00C0 && code <= 0x024F)) return 'latin';
                return 'other';
            }
            static normalize(text) {
                if (!text) return "";
                let res = text.replace(/\r\n/g, "\n").replace(/\r/g, "\n").replace(/([a-zA-Z])-\n([a-zA-Z])/g, "$1$2");
                const lines = res.split("\n");
                let processed = "";
                for (let i = 0; i < lines.length; i++) {
                    let curr = lines[i].trim();
                    if (curr.length === 0) { processed += "\n\n"; continue; }
                    if (i < lines.length - 1) {
                        let next = lines[i + 1].trim();
                        if (next.length === 0) { processed += curr + "\n"; continue; }
                        let lastChar = curr.slice(-1);
                        let nextChar = next.charAt(0);
                        const typeA = this.getScriptType(lastChar);
                        const typeB = this.getScriptType(nextChar);
                        if ((typeA === 'cjk' || typeA === 'sea') && (typeB === 'cjk' || typeB === 'sea')) processed += curr; 
                        else if ((typeA === 'cjk' && typeB === 'latin') || (typeA === 'latin' && typeB === 'cjk')) processed += curr;
                        else if (/^[-*â€¢]/.test(next) || /^[-*â€¢]/.test(curr)) processed += curr + "\n";
                        else processed += curr + " ";
                    } else { processed += curr; }
                }
                processed = processed.replace(/([\u2e80-\u9fff])\s+([\u2e80-\u9fff])/g, "$1$2");
                processed = processed.replace(/([\u2e80-\u9fff])\s+([a-zA-Z0-9])/g, "$1$2");
                processed = processed.replace(/([a-zA-Z0-9])\s+([\u2e80-\u9fff])/g, "$1$2");
                return processed.replace(/\n{3,}/g, "\n\n").trim();
            }
        }

        window.reportError = function(msg, errObj) {
            const time = new Date().toLocaleTimeString();
            const errText = errObj ? (errObj.stack || errObj.message || JSON.stringify(errObj)) : "N/A";
            const logArea = document.getElementById('error-log-area');
            if (logArea) logArea.value += `[${time}] ${msg}\n${errText}\n----------------\n`;
            console.error(msg, errObj);
            updateStatusBar(`éŒ¯èª¤: ${msg}`, 'error');
            playAudioCue('error');
        };

        window.addEventListener('pdfjs-loaded', () => {
            showReadyStatus();
        });

        // --- AI Prompts ---
        const DEFAULT_CHAT_PROMPT = `# Persona
You are a top-tier AI visual and information assistant dedicated to serving visually impaired individuals. Your core duty is to act as an extension of the user's eyes and brain, providing information that is safe, precise, and easy to receive via Screen Reader software.

# Global Rules
1. **Output Language**: Traditional Chinese (Hong Kong style).
2. **Accessibility**: Use Markdown headers (\`#\`) and lists. Avoid decorative symbols like \`[ ]\`.
3. **Content**: Be concise but rich in detail. Put main points first.`;

        const HYBRID_PROMPT = `# SYSTEM ROLE
You are a "Hybrid OCR & Accessibility Engine" for visually impaired users.
Inputs:
1. **Raw Text**: Extracted via software (may contain errors).
2. **Page Image**: The visual ground truth.

# MISSION
Reconstruct the page content into **Markdown** by cross-referencing Text and Image.

# RULES
1. **Zero Omission**: Transcribe EVERY character. Do NOT summarize.
2. **Visuals**: Describe charts/photos: \`> ğŸ–¼ï¸ [åœ–ç‰‡æè¿°]: <Detail>\`
3. **Format**: Strict Markdown. Translate foreign text to Traditional Chinese (HK).
4. **Correction**: Use Image to fix garbled Raw Text.`;

        const VISUAL_PROMPT = `# SYSTEM ROLE
You are a "Visual OCR Expert". You receive a **Page Image**.

# MISSION
Visually transcribe all text into **Markdown** and describe visual elements.

# RULES
1. **Verbatim**: Transcribe exactly as seen. No summaries.
2. **Description**: Describe non-text elements: \`> ğŸ–¼ï¸ [åœ–ç‰‡æè¿°]: <Detail>\`
3. **Language**: Traditional Chinese (HK). Translate if necessary.`;
        
        const DEFAULT_OCR_PROMPT = HYBRID_PROMPT;
        
        const DEFAULT_TRANSLATE_PROMPT = `# ROLE
Translator specializing in Traditional Chinese (Hong Kong).

# TASK
Translate input to HK Traditional Chinese.
- No summarization.
- Use HK vocabulary (e.g. æ™ºèƒ½é›»è©±, è³ªç´ ).
- Preserve Markdown.`;
        
        const PROMPT_VERSION_KEY = "prompt_ver_2025_release_v8_hybrid_final";

        const PROVIDERS = {
            gemini: { prompt: DEFAULT_CHAT_PROMPT, defaultModel: "gemini-flash-latest", canFetch: true, listUrl: "https://generativelanguage.googleapis.com/v1beta/models?key={KEY}", models: ["gemini-flash-latest", "gemini-2.5-flash", "gemini-2.0-flash", "gemini-1.5-pro", "gemini-1.5-flash"] },
            openrouter: { prompt: DEFAULT_CHAT_PROMPT, defaultModel: "qwen/qwen2.5-vl-72b-instruct", canFetch: true, listUrl: "https://openrouter.ai/api/v1/models", models: ["qwen/qwen2.5-vl-72b-instruct", "openai/gpt-4o-mini", "anthropic/claude-3.5-sonnet", "google/gemini-2.0-flash-001"] },
            datalab: { prompt: DEFAULT_OCR_PROMPT, defaultModel: "chandra", canFetch: false, listUrl: "", models: ["chandra"] },
            mistral: { prompt: DEF